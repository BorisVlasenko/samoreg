# Веб-приложение для регистрации на мероприятия

## Обзор проекта

Веб-приложение для самостоятельной регистрации на однодневные мероприятия с системой временных слотов. Разработано на Flask (Python) с использованием SQLite для хранения данных.

## Функциональность

### Административная панель
- **URL:** `/admin/{хеш}` (хеш генерируется из `ADMIN_URL_SECRET` в `app.py`)
- **Безопасность:** Доступ только по секретному URL (без пароля)
- Создание мероприятий с указанием:
  - Названия, даты
  - Времени начала/окончания
  - Длительности временного слота
  - Перерывов (если есть)
- Автоматическая генерация уникальной секретной ссылки для регистрации
- Просмотр списка зарегистрированных участников
- **Редактирование регистраций:**
  - Изменение времени слота для любого участника
  - Удаление регистраций
  - Все изменения в атомарных транзакциях БД
- Управление мероприятиями: закрытие регистрации, удаление

### Публичная страница регистрации
- **URL:** `/register/{event_hash}`
- Форма ввода данных с автоматической валидацией:
  - Имя и фамилия ребенка (автоматическое приведение к правильному регистру)
  - Номер телефона (только 10 цифр, без 8 и +7)
- Таблица временных слотов с цветовой индикацией:
  - **Белый** - свободные слоты
  - **Синий** - занятые слоты (с номером телефона)
  - **Зеленый** - ваш слот (при повторном входе)
- Проверка доступности слота на сервере при регистрации
- Автоматическое сохранение регистрации
- **Редактирование своей регистрации:**
  - При повторном входе с теми же данными можно выбрать другой слот
  - Старый слот автоматически освобождается в одной транзакции
  - Показывается сообщение об успешном изменении времени

## Технический стек

- **Backend:** Flask 3.1.2
- **Database:** SQLite (файл `events.db`)
- **Frontend:** Vanilla JavaScript, HTML, CSS
- **Python:** 3.11
- **Безопасность:** Защита секретным URL (без системы авторизации)

## Структура проекта

```
├── app.py                 # Главный файл Flask приложения
├── templates/
│   ├── admin.html        # Страница администратора
│   └── register.html     # Страница регистрации для родителей
├── static/               # Статические файлы (пусто в текущей версии)
├── events.db             # База данных SQLite (создается автоматически)
├── pyproject.toml        # Зависимости Python
└── uv.lock              # Lock-файл зависимостей
```

## База данных

### Таблица `events`
- `id` - уникальный идентификатор
- `title` - название мероприятия
- `event_date` - дата мероприятия
- `start_time` / `end_time` - временные рамки
- `slot_duration` - длительность слота в минутах
- `breaks` - JSON с перерывами
- `registration_open` - статус регистрации (открыта/закрыта)
- `event_hash` - уникальный хеш для ссылки

### Таблица `registrations`
- `id` - уникальный идентификатор
- `event_id` - связь с мероприятием
- `child_name` - имя ребенка
- `phone` - номер телефона родителя
- `slot_time` - зарегистрированное время
- `registered_at` - время регистрации

## API Endpoints

### Административные
- `GET /api/admin/events` - список мероприятий на сегодня
- `GET /api/admin/events/{id}/registrations` - список участников
- `POST /api/admin/events` - создание мероприятия
- `POST /api/admin/events/{id}/toggle` - открыть/закрыть регистрацию
- `DELETE /api/admin/events/{id}` - удаление мероприятия
- `PUT /api/admin/registrations/{id}` - изменение времени регистрации
- `DELETE /api/admin/registrations/{id}` - удаление регистрации

### Публичные
- `GET /api/event/{hash}` - информация о мероприятии
- `GET /api/event/{hash}/slots` - список временных слотов
- `POST /api/event/{hash}/register` - регистрация на слот
- `GET /api/event/{hash}/my-registration` - проверка своей регистрации

## Особенности реализации

1. **Валидация номера телефона:** Только цифры, запрет на ввод других символов через JavaScript
2. **Автоматическое приведение регистра:** Первая буква имени и фамилии заглавная
3. **Проверка доступности слота:** Race condition защита через UNIQUE constraint в БД
4. **Копирование ссылки в буфер:** Одним кликом через Clipboard API
5. **Редактирование регистраций:**
   - Пользователи могут изменить свой слот, зайдя с теми же именем и телефоном
   - Админы могут редактировать любые регистрации
   - Все операции в атомарных транзакциях (старый слот освобождается одновременно с занятием нового)
6. **Безопасность:** Доступ к админ-панели только через секретный URL без системы авторизации

## Развертывание на Tilda

Для встраивания формы регистрации на сайт Tilda используйте iframe:

```html
<iframe src="https://your-repl-url/register/{event_hash}" 
        width="100%" 
        height="800" 
        frameborder="0">
</iframe>
```

## Запуск приложения

Приложение автоматически запускается через Replit Workflow на порту 5000.

Для локального запуска:
```bash
python app.py
```

## Настройка

### Секретный URL администратора

URL админ-панели генерируется из переменной `ADMIN_URL_SECRET` в файле `app.py`:

```python
ADMIN_URL_SECRET = 'admin_secret_change_me'  # Измените это значение!
ADMIN_URL_HASH = hashlib.sha256(ADMIN_URL_SECRET.encode()).hexdigest()[:16]
```

**Важно для безопасности:**
1. Измените значение `ADMIN_URL_SECRET` на уникальную строку
2. Перезапустите приложение
3. Новый URL админ-панели: `/admin/{новый_хеш}`

Пример:
- `ADMIN_URL_SECRET = 'my_super_secret_123'` → URL: `/admin/{хеш}`
- Никто не сможет получить доступ к админ-панели без знания этого URL

## Реализованные возможности

✅ Создание мероприятий с временными слотами и перерывами  
✅ Публичная регистрация через уникальные ссылки  
✅ Редактирование регистраций пользователями (через повторный вход)  
✅ Редактирование/удаление регистраций администратором  
✅ Защита секретным URL без системы авторизации  
✅ Атомарные транзакции при изменении слотов  
✅ Относительные URL для развертывания на VDS

## Возможные улучшения (опционально)

- Фильтр мероприятий по дате (не только сегодняшние)
- Экспорт списка участников в CSV/Excel
- Редактирование созданных мероприятий (название, время)
- Email/SMS уведомления при регистрации
- Массовый импорт участников

## Дата создания

17 октября 2025

## Автор

Разработано с помощью Replit Agent
